<div id="blacksmith">
  <div class="blacksmith-bg"></div>
  <div *ngIf="showDialog" class="blacksmith-dialog">
    <span urTitle>{{ dialog }} </span>
  </div>

  <div class="inventory-container inventory">
    <tabset>
      <tab heading="Armory" id="tab1">
        <div
          class="form-check form-switch"
          (click)="
            multipleSelection.patchValue(!multipleSelection.value);
            selectedMultipleItems = []
          "
        >
          <input
            class="form-check-input"
            type="checkbox"
            [formControl]="multipleSelection"
          />
          <label
            class="form-check-label text-light"
            for="flexSwitchCheckChecked"
            >Multiple selection</label
          >
        </div>

        <app-item-inventory
          class="overflow-auto"
          [showContextualMenu]="true"
          [multipleSelection]="!!multipleSelection.value"
          [contextMenuTemplate]="'anvil'"
          [items]="currentInventory"
          [boxes]="itemInventoryBoxes"
          [disableDND]="false"
          [boxSize]="40"
          (onDragStart)="hovered = true"
          (onDragEnd)="hovered = false"
          (onDoubleClick)="
            !!$event ? (selectedMultipleItems = [$event]) : false
          "
          [(selectedItems)]="selectedMultipleItems"
        >
        </app-item-inventory>
      </tab>
      <tab heading="Materials">
        <app-materials-inventory
          [items]="currentMaterials"
          [boxes]="materialsInventoryBoxes"
        >
        </app-materials-inventory>
      </tab>
    </tabset>
  </div>

  <div class="item-container">
    <div class="container-multiple">
      @if (selectedMultipleItems.length === 0) {
        <app-item-box
          #anvil
          dndDropzone
          (dndDrop)="onAnvilDrop($event)"
          [active]="hovered"
          [ngbTooltip]="itemTooltip"
          [height]="getItemBoxSize()"
          [width]="getItemBoxSize()"
        ></app-item-box>
      } @else {
        @for (
          selectedMultipleItem of selectedMultipleItems;
          track selectedMultipleItem.id
        ) {
          <app-item-box
            #anvil
            dndDropzone
            (dndDrop)="onAnvilDrop($event)"
            [active]="hovered"
            [ngbTooltip]="itemTooltip"
            [tooltipContext]="{ item: selectedMultipleItem }"
            [height]="getItemBoxSize()"
            [width]="getItemBoxSize()"
            [upgradeLevel]="selectedMultipleItem?.upgradeLevel"
            [image]="
              selectedMultipleItem
                ? selectedMultipleItem?.itemData.imageLocal
                : null
            "
          ></app-item-box>
        }
      }
    </div>

    <div class="flex">
      <button
        (click)="openModal(false)"
        [class]="'btn btn-primary ' + getButtonSize()"
      >
        <i class="fa fa-recycle pl-1 pb-1"></i>
        Recycle
      </button>
      <button
        (click)="openModal(true)"
        [disabled]="!!multipleSelection.value"
        [class]="'btn btn-secondary mx-1 ' + getButtonSize()"
      >
        <i class="fa fa-gears pl-1 pb-1"></i>
        Upgrade
      </button>
    </div>
  </div>

  <ng-container *ngIf="resultItem">
    <div class="result-item" (click)="closeResult()">
      <div class="animate__animated animate__jackInTheBox delay_4">
        <app-item-box
          #result
          [ngbTooltip]="itemTooltip"
          [tooltipContext]="{ item: resultItem }"
          [height]="200"
          [width]="200"
          [upgradeLevel]="resultItem?.upgradeLevel"
          [image]="resultItem ? resultItem?.itemData.imageLocal : null"
        ></app-item-box>
      </div>
    </div>
  </ng-container>
  <ng-container *ngIf="resultItem === false">
    <div class="result-item" (click)="closeResult()">
      <span urTitle class="text-white">Upgrade failed ðŸ’€</span>
      <div class="animate__animated animate__hinge delay_4">
        <app-item-box
          #result
          [height]="200"
          [width]="200"
          [upgradeLevel]="selectedMultipleItems[0]?.upgradeLevel"
          [image]="
            selectedMultipleItems[0]
              ? selectedMultipleItems[0]?.itemData.imageLocal
              : null
          "
        ></app-item-box>
      </div>
    </div>
  </ng-container>
</div>

<ng-template #itemTooltip let-item="item">
  <app-item-tooltip *ngIf="item" [item]="item"></app-item-tooltip>
</ng-template>
