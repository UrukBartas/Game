<div id="tavern" class="tavern-container">
  <!-- Mission Board Section -->
  <div class="mission-board">
    <div class="board-header">
      <h2><i class="fas fa-scroll"></i> Mission Board</h2>
      <div class="board-filters">
        <button
          class="filter-btn"
          [class.active]="selectedFilter === 'ALL'"
          (click)="filterMissions('ALL')"
        >
          All
        </button>
        <button
          [ngbTooltip]="tooltipHunt"
          class="filter-btn"
          [class.active]="selectedFilter === 'HUNT'"
          (click)="filterMissions('HUNT')"
        >
          <i class="fas fa-skull"></i>
        </button>
        <button
          [ngbTooltip]="tooltipGather"
          class="filter-btn"
          [class.active]="selectedFilter === 'GATHER'"
          (click)="filterMissions('GATHER')"
        >
          <i class="fas fa-hand"></i>
        </button>
      </div>
    </div>

    <!-- Tooltip Templates -->
    <ng-template #tooltipHunt>
      <div class="tooltip-content py-3">
        <strong>Hunt Missions</strong>
        <p>Combat missions to defeat monsters and earn rewards</p>
      </div>
    </ng-template>

    <ng-template #tooltipGather>
      <div class="tooltip-content py-3">
        <strong>Gather Missions</strong>
        <p>Collect resources and materials from the world</p>
      </div>
    </ng-template>

    <!-- Mostrar banner de misiÃ³n activa si existe -->
    <app-active-mission-displayer
      (updateMissions)="refreshMissions()"
      [activeMission]="activeMission"
    ></app-active-mission-displayer>

    <div class="missions-container">
      <ng-container *ngIf="!loading; else loadingTemplate">
        <div
          class="mission-card"
          *ngFor="let mission of getFilteredMissions()"
          [class.disabled]="!canAcceptMission(mission)"
        >
          <div
            class="mission-difficulty"
            [class]="getDifficultyClass(mission.difficulty)"
          >
            {{ mission.difficulty }}
          </div>
          <h3>{{ mission.title }}</h3>
          <p>{{ mission.description }}</p>
          <div class="mission-footer">
            <div class="rewards">
              <span class="reward" *ngIf="mission.rewardUruks">
                <ng-container [ngSwitch]="mission.rewardUruks">
                  <span
                    class="uruks-indicator"
                    [ngbTooltip]="'Potential Uruk Reward'"
                  >
                    <img
                      class="uruks-icon"
                      src="{{ prefix + '/assets/goldenuruks.png' }}"
                      *ngFor="let i of getUrukIcons(mission.rewardUruks)"
                    />
                  </span>
                </ng-container>
              </span>
              <span class="reward" *ngIf="mission.rewardExperience">
                <i class="fas fa-star"></i> {{ mission.rewardExperience }}% EXP
              </span>
              <span
                class="reward materials"
                *ngIf="mission.rewardMaterials?.length"
              >
                <app-remote-item-box
                  *ngFor="let material of mission.rewardMaterials"
                  [itemId]="material.materialId"
                  [amount]="material.amount"
                  itemType="MATERIAL"
                ></app-remote-item-box>
              </span>
            </div>
            <button
              class="accept-btn"
              (click)="acceptMission(mission)"
              [disabled]="!canAcceptMission(mission)"
              [class.disabled]="!canAcceptMission(mission)"
            >
              {{ getButtonText(mission) }}
            </button>
          </div>
        </div>
      </ng-container>
    </div>
  </div>

  <ng-template #loadingTemplate>
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i> Loading missions...
    </div>
  </ng-template>

  <!-- UrukBox Chat Section -->
  <div class="urukbox" [class.expanded]="isChatExpanded">
    <div class="chat-header" (click)="toggleChat()">
      <div class="header-content">
        <i class="fas fa-comments"></i>
        <span>UrukBox Chat</span>
        <span class="online-count"
          >{{ (onlinePlayers$ | async) || 0 }} online</span
        >
      </div>
      <i
        class="fas"
        [class.fa-chevron-up]="!isChatExpanded"
        [class.fa-chevron-down]="isChatExpanded"
      ></i>
    </div>

    <div class="chat-content" *ngIf="isChatExpanded">
      <div #chatContainer class="messages-container">
        <div
          class="message"
          *ngFor="let message of messages"
          [class.own-message]="message.username === getCurrentUsername()"
        >
          <div class="message-header">
            <span class="timestamp">{{
              message.timestamp | date: 'HH:mm'
            }}</span>
            <span
              class="username"
              [ngStyle]="getPlayerNameColor(message.username)"
            >
              {{ message.username }}
            </span>
          </div>
          <div class="message-content">
            {{ message.message }}
          </div>
        </div>
      </div>

      <form class="chat-input" (ngSubmit)="sendMessage()">
        <input
          type="text"
          [formControl]="messageInput"
          placeholder="Type your message..."
          maxlength="200"
          (keydown.enter)="$event.preventDefault(); sendMessage()"
        />
        <button type="submit" [disabled]="!messageInput.value?.trim()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </form>
    </div>
  </div>
  <div class="tavern-bg"></div>
</div>
